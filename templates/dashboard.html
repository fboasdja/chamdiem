<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="/static/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>

<body>

<div class="page-enter app">

    <!-- ===== Header ===== -->
    <header class="header">
        <div>
            <h1>Dashboard</h1>
            <span>Qu·∫£n l√Ω x·ª≠ √°n & ƒëi·ªÉm</span>
        </div>
        <a href="/logout" class="logout">ƒêƒÉng xu·∫•t</a>
    </header>

    <div class="dashboard-layout">
        <!-- ===== Sidebar S·ªü ===== -->
        <aside class="side-so-tabs">
            {% if user_role == 'admin' or so_allowed in ['TRU', 'ALL'] %}
            <button class="side-so-btn {% if current_so == 'TRU' %}active{% endif %}" onclick="window.location='{{ url_for('dashboard') }}?so=TRU'">
                S·ªü TRU
            </button>
            {% endif %}
            {% if user_role == 'admin' or so_allowed in ['LS', 'ALL'] %}
            <button class="side-so-btn {% if current_so == 'LS' %}active{% endif %}" onclick="window.location='{{ url_for('dashboard') }}?so=LS'">
                S·ªü LS
            </button>
            {% endif %}
            {% if user_role == 'admin' %}
            <button class="side-so-btn" onclick="openHealTab()">Heal</button>
            {% endif %}
        </aside>

        <div class="dashboard-main">
    <!-- ===== Tabs ===== -->
    <div class="tabs">
        {% if can_see_main %}
        <button class="tab-btn active" onclick="switchTab('main')">Main</button>
        {% endif %}
        {% if can_see_diem %}
        <button class="tab-btn {% if not can_see_main %}active{% endif %}" onclick="switchTab('diem')">ƒêi·ªÉm</button>
        {% endif %}
        <button class="tab-btn {% if not can_see_main and not can_see_diem %}active{% endif %}" onclick="switchTab('thongke')">Th·ªëng k√™</button>
        {% if user_role == 'admin' %}
        <button class="tab-btn" onclick="switchTab('manage')">Manage</button>
        {% endif %}
        {% if can_see_logs %}
        <button class="tab-btn" onclick="switchTab('nhatky')">Nh·∫≠t k√Ω</button>
        {% endif %}
    </div>

    <!-- ===== Tab Main ===== -->
    {% if can_see_main %}
    <div id="tab-main" class="tab-content {% if can_see_main %}active{% endif %}">
        <!-- ===== Add row ===== -->
        <section class="card">
            <form method="post" class="add-row-responsive" id="add-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Ch·ª©c v·ª•</label>
                        <select name="chuc_vu" id="chuc_vu_select" onchange="toggleRoleFields()">
                            <option>Th·ª±c t·∫≠p</option>
                            <option>C·∫£nh s√°t vi√™n</option>
                            <option>Sƒ© quan d·ª± b·ªã</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>T√™n</label>
                        <input name="name" placeholder="T√™n" required>
                    </div>
                    
                    <div class="form-group" id="giao_thong_group">
                        <label>Giao th√¥ng</label>
                        <input type="number" name="giao_thong" id="giao_thong_input" placeholder="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label>√Ån h√¨nh s·ª± kho·∫£n 1-5</label>
                        <input type="number" name="xa_1_4" placeholder="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label>√Ån h√¨nh s·ª± kho·∫£n 6</label>
                        <input type="number" name="xa_5_6" placeholder="0" value="0">
                    </div>
                    
                    <div class="form-group" id="giam_sat_group">
                        <label>Gi√°m s√°t</label>
                        <input type="number" name="giam_sat" id="giam_sat_input" placeholder="0" value="0">
                    </div>
                    
                    <div class="form-group">
                        <label>√Ån sai</label>
                        <input type="number" name="an_sai" placeholder="0" value="0">
                    </div>
                    
                    <div class="form-group full-width">
                        <label>User ID</label>
                        <input type="text" name="user_id" id="user_id_input" placeholder="Nh·∫≠p User ID (t·ª± ƒëi·ªÅn b·∫±ng tay)">
                    </div>
                    
                    <div class="form-group full-width">
                        <button type="submit" class="btn-submit">Th√™m</button>
                    </div>
                </div>
            </form>
        </section>

        <!-- ===== Table ===== -->
        <section class="card">
            <table>
                <thead>
                    <tr>
                        <th>Ch·ª©c v·ª•</th>
                        <th>T√™n</th>
                        <th>Giao th√¥ng</th>
                        <th>√Ån h√¨nh s·ª± kho·∫£n 1-5</th>
                        <th>√Ån h√¨nh s·ª± kho·∫£n 6</th>
                        <th>Gi√°m s√°t</th>
                        <th>√Ån sai</th>
                        <th>T·ªïng</th>
                        <th>ƒêi·ªÉm</th>
                        <th>User ID</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                {% for r in data %}
                    <tr>
                        {% if user_role in ['admin', 'editer'] %}
                        <td class="chuc-vu-cell">
                            <select class="chuc-vu-select" data-id="{{r.id}}" onchange="editChucVu({{r.id}}, this.value)">
                                <option value="Th·ª±c t·∫≠p" {% if r.chuc_vu == 'Th·ª±c t·∫≠p' %}selected{% endif %}>Th·ª±c t·∫≠p</option>
                                <option value="C·∫£nh s√°t vi√™n" {% if r.chuc_vu == 'C·∫£nh s√°t vi√™n' %}selected{% endif %}>C·∫£nh s√°t vi√™n</option>
                                <option value="Sƒ© quan d·ª± b·ªã" {% if r.chuc_vu == 'Sƒ© quan d·ª± b·ªã' %}selected{% endif %}>Sƒ© quan d·ª± b·ªã</option>
                            </select>
                        </td>
                        <td contenteditable onblur="edit({{r.id}},'name',this)">{{r.name}}</td>
                        <td class="giao-thong-cell" data-chuc_vu="{{r.chuc_vu}}" data-id="{{r.id}}"
                            contenteditable onblur="edit({{r.id}},'giao_thong',this)"
                            >{{r.giao_thong or 0}}</td>
                        <td contenteditable onblur="edit({{r.id}},'xa_1_4',this)">{{r.xa_1_4}}</td>
                        <td contenteditable onblur="edit({{r.id}},'xa_5_6',this)">{{r.xa_5_6}}</td>
                        <td class="giam-sat-cell" data-chuc-vu="{{r.chuc_vu}}" data-id="{{r.id}}"
                            {% if r.chuc_vu == 'Th·ª±c t·∫≠p' %}contenteditable="false" style="opacity:0.6;cursor:not-allowed"{% else %}contenteditable onblur="edit({{r.id}},'giam_sat',this)"{% endif %}
                            >{% if r.chuc_vu == 'Th·ª±c t·∫≠p' %}X{% else %}{{r.giam_sat}}{% endif %}</td>
                        <td contenteditable onblur="edit({{r.id}},'an_sai',this)">{{r.an_sai}}</td>
                        {% else %}
                        <td>{{r.chuc_vu}}</td>
                        <td>{{r.name}}</td>
                        <td>{{r.giao_thong or 0}}</td>
                        <td>{{r.xa_1_4}}</td>
                        <td>{{r.xa_5_6}}</td>
                        <td>{% if r.chuc_vu == 'Th·ª±c t·∫≠p' %}X{% else %}{{r.giam_sat}}{% endif %}</td>
                        <td>{{r.an_sai}}</td>
                        {% endif %}
                        <td class="muted tong_an">{{r.tong_an}}</td>
                        <td class="strong diem">{{r.diem}}</td>
                        <td class="muted">{{r.user_id or '-'}}</td>
                        {% if user_role in ['admin', 'editer'] %}
                        <td><a href="/delete/{{r.id}}" class="del">√ó</a></td>
                        {% else %}
                        <td></td>
                        {% endif %}
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </section>
    </div>
    {% endif %}

    <!-- ===== Tab Heal ===== -->
    <div id="tab-heal" class="tab-content">
        <section class="card">
            <h2>Heal</h2>
            <p class="muted">Gi·ªØ tab n√†y m·ªü ƒë·ªÉ ping duy tr√¨ web.</p>
            <div class="heal-box">
                <div class="heal-row">
                    <span class="muted">URL</span>
                    <input id="heal-url" placeholder="ƒê·ªÉ tr·ªëng = /health" value="">
                </div>
                <div class="heal-row">
                    <span class="muted">Tr·∫°ng th√°i</span>
                    <span id="heal-status" class="strong">Ch∆∞a ch·∫°y</span>
                </div>
                <div class="heal-row">
                    <button class="btn-toggle" onclick="startHeal()">Start</button>
                    <button class="btn-toggle" onclick="stopHeal()">Stop</button>
                </div>
            </div>
        </section>
    </div>

    <!-- ===== Tab ƒêi·ªÉm (user, editer, admin - ch·ªâ xem) ===== -->
    {% if can_see_diem %}
    <div id="tab-diem" class="tab-content {% if not can_see_main %}active{% endif %}">
        <section class="card diem-page">
            <div class="diem-header-row">
                <div class="diem-header-left">
                    <h3 class="diem-title">ƒêi·ªÉm b·∫£ng</h3>
                    <p class="diem-subtitle">B·∫£ng t·ªïng h·ª£p theo h√†ng</p>
                </div>
                <div class="diem-view-tabs">
                    <button class="diem-view-btn active" data-view="bang" onclick="switchDiemView('bang', this)">ƒêi·ªÉm b·∫£ng</button>
                    <button class="diem-view-btn" data-view="rieng" onclick="switchDiemView('rieng', this)">ƒêi·ªÉm ri√™ng</button>
                </div>
            </div>

            <!-- View: ƒêi·ªÉm b·∫£ng (table) -->
            <div id="diem-view-bang" class="diem-view active">
                <div class="diem-main-title">
                    <h2 id="monthly-title-text">{{ monthly_title }}</h2>
                    {% if can_edit_title %}
                    <button class="btn-toggle btn-title-edit" onclick="editMonthlyTitle()">S·ª≠a ti√™u ƒë·ªÅ</button>
                    {% endif %}
                </div>
                <div class="diem-table-scroll">
                    <table class="top-scores-table">
                        <thead>
                            <tr>
                                <th>Ch·ª©c v·ª•</th>
                                <th>T√™n</th>
                                <th>Giao th√¥ng</th>
                                <th>√Ån h√¨nh s·ª± kho·∫£n 1-5</th>
                                <th>√Ån h√¨nh s·ª± kho·∫£n 6</th>
                                <th>Gi√°m s√°t</th>
                                <th>√Ån sai</th>
                                <th>T·ªïng</th>
                                <th>ƒêi·ªÉm</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in data %}
                            <tr>
                                <td>{{ r.chuc_vu }}</td>
                                <td><strong>{{ r.name }}</strong></td>
                                <td>{{ r.giao_thong or 0 }}</td>
                                <td>{{ r.xa_1_4 }}</td>
                                <td>{{ r.xa_5_6 }}</td>
                                <td>{% if r.chuc_vu == 'Th·ª±c t·∫≠p' %}X{% else %}{{ r.giam_sat }}{% endif %}</td>
                                <td>{{ r.an_sai }}</td>
                                <td class="muted">{{ r.tong_an }}</td>
                                <td class="strong">{{ r.diem }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% if not data %}
                <p class="diem-empty">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                {% endif %}
            </div>

            <!-- View: ƒêi·ªÉm ri√™ng (card nh∆∞ c≈©) -->
            <div id="diem-view-rieng" class="diem-view" style="display:none;">
                <div class="diem-cards">
                    {% for r in data %}
                    <div class="diem-card">
                        <div class="diem-card-header">
                            <span class="diem-chuc-vu">{{r.chuc_vu}}</span>
                            <span class="diem-ten">{{r.name}}</span>
                        </div>
                        <div class="diem-card-body">
                            <div class="diem-row">
                                <span class="diem-label">Giao th√¥ng</span>
                                <span class="diem-val">{{r.giao_thong or 0}}</span>
                            </div>
                            <div class="diem-row">
                                <span class="diem-label">√Ån h√¨nh s·ª± kho·∫£n 1-5</span>
                                <span class="diem-val">{{r.xa_1_4}}</span>
                            </div>
                            <div class="diem-row">
                                <span class="diem-label">√Ån h√¨nh s·ª± kho·∫£n 6</span>
                                <span class="diem-val">{{r.xa_5_6}}</span>
                            </div>
                            <div class="diem-row">
                                <span class="diem-label">Gi√°m s√°t</span>
                                <span class="diem-val">{% if r.chuc_vu == 'Th·ª±c t·∫≠p' %}‚Äî{% else %}{{r.giam_sat}}{% endif %}</span>
                            </div>
                            <div class="diem-row">
                                <span class="diem-label">√Ån sai</span>
                                <span class="diem-val">{{r.an_sai}}</span>
                            </div>
                        </div>
                        <div class="diem-card-footer">
                            <div class="diem-footer-item">
                                <span class="diem-footer-label">T·ªïng</span>
                                <span class="diem-footer-val">{{r.tong_an}}</span>
                            </div>
                            <div class="diem-footer-item diem-highlight">
                                <span class="diem-footer-label">ƒêi·ªÉm ri√™ng</span>
                                <span class="diem-footer-val diem-score">{{r.diem}}</span>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% if not data %}
                <p class="diem-empty">Ch∆∞a c√≥ d·ªØ li·ªáu</p>
                {% endif %}
            </div>
        </section>
    </div>
    {% endif %}

    <!-- ===== Tab Manage (Admin) ===== -->
    {% if user_role == 'admin' %}
    <div id="tab-manage" class="tab-content">
        <section class="card">
            <div class="manage-header">
                <h2>Qu·∫£n l√Ω t√†i kho·∫£n</h2>
                <button class="btn-toggle" onclick="loadUsers()">T·∫£i l·∫°i</button>
            </div>

            <div class="manage-grid">
                <div class="manage-card">
                    <h3>T·∫°o t√†i kho·∫£n</h3>
                    <form id="createAccountForm" class="create-account-form">
                        <div class="form-row">
                            <div class="input-group-full">
                                <input type="text" id="new_username" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="input-group-full">
                                <input type="password" id="new_password" placeholder="M·∫≠t kh·∫©u" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="input-group-full">
                                <select id="new_role" required>
                                    <option value="user">user</option>
                                    <option value="editer">editer</option>
                                    <option value="admin">admin</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="input-group-full">
                                <select id="new_so" required>
                                    <option value="TRU">S·ªü TRU</option>
                                    <option value="LS">S·ªü LS</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <button type="submit" class="btn-create">T·∫°o t√†i kho·∫£n</button>
                        </div>
                        <div id="createAccountResult" class="result-message"></div>
                    </form>
                </div>

                <div class="manage-card">
                    <h3>Danh s√°ch t√†i kho·∫£n</h3>
                    <div class="top-scores-container">
                        <table class="top-scores-table">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Role</th>
                                    <th>S·ªü</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="users-body">
                                <tr><td colspan="6" style="text-align:center;color:#9ca3af;">ƒêang t·∫£i...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
    {% endif %}

        </div> <!-- dashboard-main -->
    </div> <!-- dashboard-layout -->

    <!-- ===== Tab Th·ªëng k√™ ===== -->
    <div id="tab-thongke" class="tab-content {% if not can_see_main %}active{% endif %}">
        <!-- ===== Chart Section ===== -->
        <section class="card">
            <div class="chart-header">
                <h2>Th·ªëng k√™ ƒëi·ªÉm s·ªü Paleto Bay Sheriff</h2>
                <div class="chart-controls">
                    <button id="chart-toggle" class="btn-toggle" onclick="toggleChartType()">
                        <span id="chart-type-text">C·ªôt</span>
                    </button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="statsChart"></canvas>
            </div>
        </section>

        <!-- ===== Top High Scores ===== -->
        <section class="card">
            <h2>Top ng∆∞·ªùi ƒëi·ªÉm cao</h2>
            <div class="top-scores-container">
                <table class="top-scores-table">
                    <thead>
                        <tr>
                            <th>H·∫°ng</th>
                            <th>T√™n</th>
                            <th>T·ªïng ƒëi·ªÉm</th>
                        </tr>
                    </thead>
                    <tbody id="top-scores-body">
                        <tr>
                            <td colspan="3" style="text-align: center; color: #9ca3af;">ƒêang t·∫£i...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- ===== Tab Nh·∫≠t k√Ω ===== -->
    {% if can_see_logs %}
    <div id="tab-nhatky" class="tab-content">
        <section class="card">
            <h2>Nh·∫≠t k√Ω ho·∫°t ƒë·ªông</h2>
            <div class="nhatky-container">
                <table class="nhatky-table">
                    <thead>
                        <tr>
                            <th>Th·ªùi gian</th>
                            <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                            <th>H√†nh ƒë·ªông</th>
                            <th>Chi ti·∫øt</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in nhat_ky %}
                        <tr>
                            <td>{{log.time}}</td>
                            <td><strong>{{log.user_name}}</strong></td>
                            <td>
                                {% if log.action == 'ADD' %}
                                    <span style="color: #60a5fa;">‚ûï Th√™m</span>
                                {% elif log.action == 'INLINE_EDIT' %}
                                    <span style="color: #fbbf24;">‚úèÔ∏è Ch·ªânh s·ª≠a</span>
                                {% elif log.action == 'DELETE' %}
                                    <span style="color: #ef4444;">üóëÔ∏è X√≥a</span>
                                {% elif log.action == 'CREATE_ACCOUNT' %}
                                    <span style="color: #10b981;">üë§ T·∫°o t√†i kho·∫£n</span>
                                {% else %}
                                    {{log.action}}
                                {% endif %}
                            </td>
                            <td>{{log.details}}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </section>
    </div>
    {% endif %}

</div>

<script>
let chart = null;
let chartType = 'bar'; // 'bar' ho·∫∑c 'line'

// Toggle Giao th√¥ng + Gi√°m s√°t theo ch·ª©c v·ª• (form th√™m m·ªõi)
function toggleRoleFields() {
    const chucVuSelect = document.getElementById('chuc_vu_select');
    const giamSatInput = document.getElementById('giam_sat_input');
    const giaoThongInput = document.getElementById('giao_thong_input');
    const giaoThongGroup = document.getElementById('giao_thong_group');
    const giamSatGroup = document.getElementById('giam_sat_group');
    
    // Th·ª±c t·∫≠p: c√≥ Giao th√¥ng, kh√¥ng c√≥ Gi√°m s√°t
    // C·∫£nh s√°t vi√™n / Sƒ© quan d·ª± b·ªã: c√≥ c·∫£ Giao th√¥ng + Gi√°m s√°t
    if (chucVuSelect.value === 'Th·ª±c t·∫≠p') {
        // Hi·ªán Giao th√¥ng, ·∫©n Gi√°m s√°t
        giaoThongGroup.style.display = 'block';
        giaoThongInput.disabled = false;
        giaoThongInput.placeholder = '0';
        giaoThongInput.style.opacity = '1';
        giaoThongInput.style.cursor = 'text';
        giamSatGroup.style.display = 'none';
        giamSatInput.value = 0;
    } else {
        // Hi·ªán c·∫£ Giao th√¥ng + Gi√°m s√°t
        giaoThongGroup.style.display = 'block';
        giaoThongInput.disabled = false;
        giaoThongInput.placeholder = '0';
        giaoThongInput.style.opacity = '1';
        giaoThongInput.style.cursor = 'text';
        giamSatGroup.style.display = 'block';
        giamSatInput.disabled = false;
        giamSatInput.placeholder = '0';
        giamSatInput.style.opacity = '1';
        giamSatInput.style.cursor = 'text';
    }
}

// ƒê·ªïi gi·ªØa view "ƒêi·ªÉm b·∫£ng" v√† "ƒêi·ªÉm ri√™ng"
function switchDiemView(view, btn) {
    const bang = document.getElementById('diem-view-bang');
    const rieng = document.getElementById('diem-view-rieng');
    if (!bang || !rieng) return;

    if (view === 'bang') {
        bang.classList.add('active');
        bang.style.display = 'block';
        rieng.classList.remove('active');
        rieng.style.display = 'none';
    } else {
        bang.classList.remove('active');
        bang.style.display = 'none';
        rieng.classList.add('active');
        rieng.style.display = 'block';
    }

    // C·∫≠p nh·∫≠t n√∫t active
    document.querySelectorAll('.diem-view-btn').forEach(b => b.classList.remove('active'));
    if (btn) {
        btn.classList.add('active');
    }
}

// Admin ch·ªânh s·ª≠a ti√™u ƒë·ªÅ "TH·ªêNG K√ä ƒêI·ªÇM TH√ÅNG"
function editMonthlyTitle() {
    const titleEl = document.getElementById('monthly-title-text');
    if (!titleEl) return;
    const current = titleEl.innerText.trim() || 'TH·ªêNG K√ä ƒêI·ªÇM TH√ÅNG';
    const next = prompt('Nh·∫≠p ti√™u ƒë·ªÅ m·ªõi cho ph·∫ßn th·ªëng k√™ ƒëi·ªÉm th√°ng:', current);
    if (!next || !next.trim()) return;

    fetch('/api/settings/monthly_title', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title: next.trim()})
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            titleEl.innerText = d.title;
        } else if (d.error) {
            alert(d.error);
        }
    })
    .catch(err => {
        console.error(err);
        alert('L·ªói khi c·∫≠p nh·∫≠t ti√™u ƒë·ªÅ');
    });
}

// ===== Sidebar Heal =====
let _healTimer = null;

function openHealTab() {
    switchTab('heal');
    // ping lu√¥n 1 l·∫ßn ƒë·ªÉ th·∫•y ho·∫°t ƒë·ªông
    if (!_healTimer) {
        startHeal();
    }
}

function startHeal() {
    stopHeal();
    const urlInput = document.getElementById('heal-url');
    const statusEl = document.getElementById('heal-status');
    const target = (urlInput && urlInput.value && urlInput.value.trim()) ? urlInput.value.trim() : '/health';

    const ping = async () => {
        try {
            const r = await fetch(target);
            const text = await r.text();
            if (statusEl) statusEl.innerText = `OK (${new Date().toLocaleTimeString()})`;
        } catch (e) {
            if (statusEl) statusEl.innerText = `L·ªói (${new Date().toLocaleTimeString()})`;
        }
    };

    ping();
    _healTimer = setInterval(ping, 30000);
}

function stopHeal() {
    const statusEl = document.getElementById('heal-status');
    if (_healTimer) {
        clearInterval(_healTimer);
        _healTimer = null;
    }
    if (statusEl) statusEl.innerText = 'ƒê√£ d·ª´ng';
}

// Edit ch·ª©c v·ª• qua select (ch·ªâ 3 l·ª±a ch·ªçn)
function editChucVu(id, value) {
    fetch("/inline_edit", {
        method: "POST",
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ id, field: 'chuc_vu', value })
    })
    .then(r => r.json())
    .then(d => {
        if (d.success) {
            const tr = document.querySelector(`select.chuc-vu-select[data-id="${id}"]`)?.closest('tr');
            if (tr) {
                tr.querySelector(".tong_an").innerText = d.tong_an;
                tr.querySelector(".diem").innerText = d.diem;
                const gtCell = tr.querySelector(".giao-thong-cell");
                const gsCell = tr.querySelector(".giam-sat-cell");
                if (value === 'Th·ª±c t·∫≠p') {
                    // Th·ª±c t·∫≠p: c√≥ Giao th√¥ng, kh√¥ng c√≥ Gi√°m s√°t
                    gtCell.setAttribute('contenteditable', 'true');
                    gtCell.style.opacity = '1';
                    gtCell.style.cursor = 'text';
                    gtCell.innerText = d.giao_thong ?? 0;
                    gtCell.setAttribute('data-chuc-vu', 'Th·ª±c t·∫≠p');
                    gtCell.onblur = () => edit(id, 'giao_thong', gtCell);
                    gsCell.setAttribute('contenteditable', 'false');
                    gsCell.style.opacity = '0.6';
                    gsCell.style.cursor = 'not-allowed';
                    gsCell.innerText = 'X';
                    gsCell.setAttribute('data-chuc-vu', 'Th·ª±c t·∫≠p');
                } else {
                    // C·∫£nh s√°t vi√™n / Sƒ© quan d·ª± b·ªã: c√≥ Giao th√¥ng v√† Gi√°m s√°t
                    gtCell.setAttribute('contenteditable', 'true');
                    gtCell.style.opacity = '1';
                    gtCell.style.cursor = 'text';
                    gtCell.innerText = d.giao_thong ?? 0;
                    gtCell.setAttribute('data-chuc-vu', value);
                    gtCell.onblur = () => edit(id, 'giao_thong', gtCell);
                    gsCell.setAttribute('contenteditable', 'true');
                    gsCell.style.opacity = '1';
                    gsCell.style.cursor = 'text';
                    gsCell.innerText = d.giam_sat ?? 0;
                    gsCell.setAttribute('data-chuc-vu', value);
                    gsCell.onblur = () => edit(id, 'giam_sat', gsCell);
                }
            }
        }
    });
}

// Kh·ªüi t·∫°o khi trang load
document.addEventListener('DOMContentLoaded', function() {
    toggleRoleFields();
});

function edit(id, field, el){
    const val = (el.innerText || "").trim()
    fetch("/inline_edit",{
        method:"POST",
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ id, field, value: val })
    })
    .then(r=>r.json())
    .then(d=>{
        if(d.success){
            const tr = el.closest("tr")
            tr.querySelector(".tong_an").innerText = d.tong_an
            tr.querySelector(".diem").innerText = d.diem
            // C·∫≠p nh·∫≠t √¥ s·ªë v·ªõi gi√° tr·ªã ƒë√£ l∆∞u (x√≥a h·∫øt = 0, l·ªói = 0)
            if(d.saved_value !== undefined){
                el.innerText = d.saved_value
            }
        }
    })
}

document.addEventListener("keydown", e=>{
    if(e.key==="Enter" && e.target.hasAttribute("contenteditable")){
        e.preventDefault()
        e.target.blur()
    }
})

// Tab switching
function switchTab(tabName) {
    // ·∫®n t·∫•t c·∫£ tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // X√≥a active t·ª´ t·∫•t c·∫£ buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Hi·ªÉn th·ªã tab ƒë∆∞·ª£c ch·ªçn
    const targetTab = document.getElementById(`tab-${tabName}`);
    if(targetTab) {
        targetTab.classList.add('active');
    }
    
    // Set active cho button t∆∞∆°ng ·ª©ng
    document.querySelectorAll('.tab-btn').forEach(btn => {
        const btnText = btn.textContent.trim();
        if((tabName === 'main' && btnText === 'Main') ||
           (tabName === 'diem' && btnText === 'ƒêi·ªÉm') ||
           (tabName === 'thongke' && btnText === 'Th·ªëng k√™') ||
           (tabName === 'manage' && btnText === 'Manage') ||
           (tabName === 'nhatky' && btnText === 'Nh·∫≠t k√Ω')) {
            btn.classList.add('active');
        }
    });
    
    // N·∫øu l√† tab th·ªëng k√™, load d·ªØ li·ªáu
    if(tabName === 'thongke') {
        loadStatistics();
        loadTopScores();
    }
}

// (ƒë√£ b·ªè discord_id) user_id nh·∫≠p tay

// T·ª± ƒë·ªông load th·ªëng k√™ n·∫øu user ch·ªâ c√≥ quy·ªÅn xem th·ªëng k√™
{% if not can_see_main %}
document.addEventListener('DOMContentLoaded', function() {
    loadStatistics();
    loadTopScores();
});
{% endif %}

// Load statistics chart
function loadStatistics() {
    fetch(`/api/thongke?so={{ current_so }}`)
        .then(r => r.json())
        .then(data => {
            const labels = data.map(d => d.month);
            const values = data.map(d => d.value);
            
            const ctx = document.getElementById('statsChart').getContext('2d');
            
            // X√≥a chart c≈© n·∫øu c√≥
            if(chart) {
                chart.destroy();
            }
            
            chart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'T·ªïng s·ªë PS',
                        data: values,
                        backgroundColor: chartType === 'bar' ? 'rgba(37, 99, 235, 0.6)' : 'rgba(37, 99, 235, 0.2)',
                        borderColor: 'rgba(37, 99, 235, 1)',
                        borderWidth: 2,
                        fill: chartType === 'line',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#e5e7eb'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(31, 41, 55, 0.5)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#9ca3af'
                            },
                            grid: {
                                color: 'rgba(31, 41, 55, 0.5)'
                            }
                        }
                    }
                }
            });
        })
        .catch(err => {
            console.error('Error loading statistics:', err);
        });
}

// Toggle chart type
function toggleChartType() {
    chartType = chartType === 'bar' ? 'line' : 'bar';
    document.getElementById('chart-type-text').innerText = chartType === 'bar' ? 'C·ªôt' : 'ƒê∆∞·ªùng';
    loadStatistics();
}

// Load top scores
function loadTopScores() {
    fetch(`/api/top?so={{ current_so }}`)
        .then(r => r.json())
        .then(data => {
            const tbody = document.getElementById('top-scores-body');
            if(data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #9ca3af;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.map((item, index) => {
                const rank = index + 1;
                const medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : '';
                return `
                    <tr>
                        <td><span class="rank">${medal} ${rank}</span></td>
                        <td><strong>${item.name}</strong></td>
                        <td class="score-value">${item.score || 0}</td>
                    </tr>
                `;
            }).join('');
        })
        .catch(err => {
            console.error('Error loading top scores:', err);
            document.getElementById('top-scores-body').innerHTML = 
                '<tr><td colspan="3" style="text-align: center; color: #ef4444;">L·ªói khi t·∫£i d·ªØ li·ªáu</td></tr>';
        });
}

// T·∫°o t√†i kho·∫£n t·ª´ dashboard
const createAccountForm = document.getElementById('createAccountForm');
if(createAccountForm) {
    createAccountForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        const username = document.getElementById('new_username').value.trim();
        const password = document.getElementById('new_password').value;
        const role = document.getElementById('new_role').value;
        const so = (document.getElementById('new_so')?.value) || 'TRU';
        const resultDiv = document.getElementById('createAccountResult');
        
        if(!username || !password) {
            resultDiv.innerHTML = '<div style="color: #ef4444; padding: 12px; background: #1f2937; border-radius: 8px;">Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin</div>';
            return;
        }
        
        try {
            const response = await fetch('/api/addaccount', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username, password, role, so})
            });

            const contentType = response.headers.get('content-type') || '';
            let data;

            // ƒê·∫£m b·∫£o ch·ªâ parse JSON khi server th·∫≠t s·ª± tr·∫£ JSON
            if (contentType.includes('application/json')) {
                data = await response.json();
            } else {
                const text = await response.text();
                throw new Error(`Server tr·∫£ v·ªÅ d·ªØ li·ªáu kh√¥ng ph·∫£i JSON: ${text.slice(0, 120)}...`);
            }

            // N·∫øu HTTP status l·ªói nh∆∞ng v·∫´n c√≥ JSON
            if (!response.ok) {
                const errMsg = (data && (data.error || data.message)) || `L·ªói HTTP ${response.status}`;
                resultDiv.innerHTML = `<div style="color: #ef4444; padding: 12px; background: #1f2937; border-radius: 8px;">‚ùå ${errMsg}</div>`;
                return;
            }

            if(data.success) {
                const codeMsg = data.code ? `<br><strong>M√£ ƒëƒÉng nh·∫≠p: ${data.code}</strong>` : '';
                resultDiv.innerHTML = `<div style="color: #10b981; padding: 12px; background: #1f2937; border-radius: 8px;">‚úÖ ${data.message}${codeMsg}</div>`;
                document.getElementById('createAccountForm').reset();
            } else {
                resultDiv.innerHTML = `<div style="color: #ef4444; padding: 12px; background: #1f2937; border-radius: 8px;">‚ùå ${data.error}</div>`;
            }
        } catch(error) {
            resultDiv.innerHTML = `<div style="color: #ef4444; padding: 12px; background: #1f2937; border-radius: 8px;">‚ùå L·ªói: ${error.message}</div>`;
        }
    });
}

async function loadUsers() {
    const tbody = document.getElementById('users-body');
    if(!tbody) return;
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:#9ca3af;">ƒêang t·∫£i...</td></tr>';
    try{
        const r = await fetch('/api/users');
        const d = await r.json();
        if(!d.success){
            tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#ef4444;">${d.error || 'L·ªói'}</td></tr>`;
            return;
        }
        tbody.innerHTML = d.users.map(u => `
            <tr>
                <td>${u.id}</td>
                <td><strong>${u.username}</strong></td>
                <td><span class="muted">${u.password || ''}</span></td>
                <td>
                    <select onchange="updateUserRole(${u.id}, this.value)" ${u.role==='admin' ? 'disabled' : ''}>
                        <option value="admin" ${u.role==='admin' ? 'selected' : ''}>admin</option>
                        <option value="editer" ${u.role==='editer' ? 'selected' : ''}>editer</option>
                        <option value="user" ${u.role==='user' ? 'selected' : ''}>user</option>
                    </select>
                </td>
                <td>
                    <select onchange="updateUserSo(${u.id}, this.value)" ${u.role==='admin' ? 'disabled' : ''}>
                        <option value="TRU" ${(u.so||'TRU')==='TRU' ? 'selected' : ''}>TRU</option>
                        <option value="LS" ${(u.so||'TRU')==='LS' ? 'selected' : ''}>LS</option>
                    </select>
                </td>
                <td>
                    ${u.role==='admin' ? '' : `<button class="btn-toggle" onclick="deleteUser(${u.id})">X√≥a</button>`}
                </td>
            </tr>
        `).join('');
    }catch(e){
        tbody.innerHTML = `<tr><td colspan="6" style="text-align:center;color:#ef4444;">${e.message}</td></tr>`;
    }
}

async function updateUserRole(id, role){
    await fetch(`/api/users/${id}/role`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({role})});
}

async function updateUserSo(id, so){
    const r = await fetch(`/api/users/${id}/so`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({so})});
    const d = await r.json();
    if(!d.success){
        alert(d.error || 'L·ªói');
        loadUsers();
    }
}

async function deleteUser(id){
    if(!confirm('X√≥a t√†i kho·∫£n n√†y?')) return;
    const r = await fetch(`/api/users/${id}`, {method:'DELETE'});
    const d = await r.json();
    if(!d.success) alert(d.error || 'L·ªói');
    loadUsers();
}

document.addEventListener('DOMContentLoaded', function(){
    loadUsers();
});
</script>

</body>
</html>
